import re
from faker import Faker
import random
from datetime import datetime

# Faker kÃ¼tÃ¼phanesini TÃ¼rkÃ§e dil desteÄŸiyle baÅŸlatalÄ±m
fake = Faker('tr_TR')


class PlakaKontrol:
    """
    T.C. plaka formatÄ±nÄ± kontrol eden, ÅŸehir, tip bilgisi veren ve detaylÄ± simÃ¼lasyon verisi Ã¼reten sÄ±nÄ±f.
    """

    # --- REGEX KALIPLARI ---
    IL_KODU_REGEX = r"(0[1-9]|[1-7]\d|8[0-1])"
    SIVIL_REGEX = r"^" + IL_KODU_REGEX + r"([A-Z]{1,3})(\d{1,4})$"
    TURK_PLAKA_REGEX = SIVIL_REGEX

    # 81 Ä°LÄ°N KOD - Ä°SÄ°M EÅLEÅMESÄ°
    IL_KODLARI = {
        "01": "Adana", "02": "AdÄ±yaman", "03": "Afyonkarahisar", "04": "AÄŸrÄ±", "05": "Amasya",
        "06": "Ankara", "07": "Antalya", "08": "Artvin", "09": "AydÄ±n", "10": "BalÄ±kesir",
        "11": "Bilecik", "12": "BingÃ¶l", "13": "Bitlis", "14": "Bolu", "15": "Burdur",
        "16": "Bursa", "17": "Ã‡anakkale", "18": "Ã‡ankÄ±rÄ±", "19": "Ã‡orum", "20": "Denizli",
        "21": "DiyarbakÄ±r", "22": "Edirne", "23": "ElazÄ±ÄŸ", "24": "Erzincan", "25": "Erzurum",
        "26": "EskiÅŸehir", "27": "Gaziantep", "28": "Giresun", "29": "GÃ¼mÃ¼ÅŸhane", "30": "Hakkari",
        "31": "Hatay", "32": "Isparta", "33": "Mersin", "34": "Ä°stanbul", "35": "Ä°zmir",
        "36": "Kars", "37": "Kastamonu", "38": "Kayseri", "39": "KÄ±rklareli", "40": "KÄ±rÅŸehir",
        "41": "Kocaeli", "42": "Konya", "43": "KÃ¼tahya", "44": "Malatya", "45": "Manisa",
        "46": "KahramanmaraÅŸ", "47": "Mardin", "48": "MuÄŸla", "49": "MuÅŸ", "50": "NevÅŸehir",
        "51": "NiÄŸde", "52": "Ordu", "53": "Rize", "54": "Sakarya", "55": "Samsun",
        "56": "Siirt", "57": "Sinop", "58": "Sivas", "59": "TekirdaÄŸ", "60": "Tokat",
        "61": "Trabzon", "62": "Tunceli", "63": "ÅanlÄ±urfa", "64": "UÅŸak", "65": "Van",
        "66": "Yozgat", "67": "Zonguldak", "68": "Aksaray", "69": "Bayburt", "70": "Karaman",
        "71": "KÄ±rÄ±kkale", "72": "Batman", "73": "ÅÄ±rnak", "74": "BartÄ±n", "75": "Ardahan",
        "76": "IÄŸdÄ±r", "77": "Yalova", "78": "KarabÃ¼k", "79": "Kilis", "80": "Osmaniye",
        "81": "DÃ¼zce"
    }

    def __init__(self, plaka: str):
        self.orijinal_plaka = plaka
        self.temizlenmis_plaka = self._plakayi_temizle(plaka)
        self.hata_mesaji = ""
        self.plaka_tipi = "TanÄ±mlanamadÄ±"
        self.gecerli = False
        self.simule_veri = {}  # Rastgele Ã¼retilen veriyi burada tutacaÄŸÄ±z

    def _plakayi_temizle(self, plaka: str) -> str:
        return plaka.strip().upper().replace(" ", "")

    def gecerli_mi(self) -> bool:
        """Plaka formatÄ±nÄ±n geÃ§erli olup olmadÄ±ÄŸÄ±nÄ± kontrol eder ve hata/tip mesajlarÄ±nÄ± gÃ¼nceller."""
        plaka = self.temizlenmis_plaka

        if not re.match(r"^[A-Z0-9]+$", plaka):
            self.hata_mesaji = "Plaka dizesinde sadece harf (A-Z) ve rakam (0-9) kullanÄ±lmalÄ±dÄ±r."
            self.gecerli = False
            return False

        match = re.match(self.TURK_PLAKA_REGEX, plaka)

        if match:
            self.gecerli = True
            self.plaka_tipi = "Sivil Standart Plaka"  # Basit tutmak iÃ§in sadece sivil kontrolÃ¼
            return True
        else:
            il_kodu_str = plaka[:2]
            if not re.match(r"^[0-9]{2}$", il_kodu_str) or il_kodu_str not in self.IL_KODLARI:
                self.hata_mesaji = f"Ä°lk iki karakter ya sayÄ± deÄŸil ya da T.C. plaka kodlarÄ± aralÄ±ÄŸÄ±nda (01-81) deÄŸildir."
            elif len(plaka) < 4 or len(plaka) > 9:
                self.hata_mesaji = f"Plaka uzunluÄŸu hatalÄ±. ({len(plaka)} karakter). GeÃ§erli uzunluk 4-9 karakterdir."
            else:
                self.hata_mesaji = "Plaka gruplarÄ±nÄ±n uzunluklarÄ± (Harf: 1-3, Rakam: 1-4) veya sÄ±ralamasÄ± hatalÄ±dÄ±r."

            self.gecerli = False
            return False

    def _getir_sehir_adi(self, il_kodu: str) -> str:
        return self.IL_KODLARI.get(il_kodu, "BÄ°LÄ°NMEYEN Ä°L KODU")

    def _rastgele_kullanici_uret(self):
        """Faker kullanarak detaylÄ± rastgele kullanÄ±cÄ± ve araÃ§ bilgileri Ã¼retir."""

        # DetaylÄ± simÃ¼lasyon verileri
        ilk_dogum_tarihi = fake.date_of_birth(minimum_age=25, maximum_age=70)
        ikamet_ili = fake.city()
        banka_parasi = random.randint(1000, 5000000)

        # Ana simÃ¼lasyon verileri
        marka = random.choice(["Toyota", "Renault", "Fiat", "Ford", "Volkswagen", "BMW", "Mercedes"])

        simule_veri = {
            "Ruhsat Sahibi": fake.name(),
            "TC Kimlik No": fake.unique.random_number(digits=11),
            "Telefon NumarasÄ±": fake.phone_number(),  # Yeni Eklenen Alan
            "Marka / Model": f"{marka} {fake.word().capitalize()} {str(random.randint(100, 999))}",
            "Ruhsat Sahibi Ä°l": ikamet_ili,
            "Muayene GeÃ§erlilik": random.choice(["GeÃ§erli", "SÃ¼resi DolmuÅŸ"]),
            "Sigorta Durumu": random.choice(["GeÃ§erli", "SÃ¼resi DolmuÅŸ"]),
            "Trafik CezasÄ± Borcu": f"{random.randint(0, 3000):,} TL" if random.choice([True, False]) else "Yok",
            # AyrÄ±ntÄ±lÄ± Bilgiler (AraÅŸtÄ±r komutu iÃ§in)
            "Dogum Tarihi": ilk_dogum_tarihi.strftime('%d.%m.%Y'),
            "Dogum Yeri": fake.city(),
            "KÃ¼tÃ¼k Ä°l/Ä°lÃ§e": f"{fake.city()}/{fake.city()}",
            "Ikametgah Adresi": fake.address(),
            "Banka Hesabi Bakiyesi": f"{banka_parasi:,.2f} TL"
        }
        self.simule_veri = simule_veri
        return simule_veri

    def raporu_olustur(self) -> str:
        """KÄ±sa kontrol raporunu oluÅŸturur."""

        self.gecerli_mi()
        cizgi = "=" * 70
        ayirici = "-" * 70

        rapor = f"\n{cizgi}\n"
        rapor += f"| PLAKA KONTROL SONUCU: {self.orijinal_plaka}\n"
        rapor += f"{cizgi}\n"

        sonuc_mesaji = "**âœ… GEÃ‡ERLÄ° PLAKA FORMATI**" if self.gecerli else "**âŒ GEÃ‡ERSÄ°Z PLAKA FORMATI**"

        rapor += f"Format KontrolÃ¼: {sonuc_mesaji}\n"
        rapor += f"Temiz Plaka:     {self.temizlenmis_plaka}\n"
        rapor += ayirici + "\n"

        if not self.gecerli:
            rapor += f"âš ï¸ NEDEN GEÃ‡ERSÄ°Z: {self.hata_mesaji}\n"
            rapor += ayirici + "\n"
            return rapor

        # Plaka geÃ§erliyse
        match = re.match(self.TURK_PLAKA_REGEX, self.temizlenmis_plaka)
        il_kodu = match.group(1)
        sehir_adi = self._getir_sehir_adi(il_kodu)

        # SimÃ¼lasyon verisini Ã¼ret ve sakla
        kullanici_bilgileri = self._rastgele_kullanici_uret()

        rapor += "ğŸ”¢ AYRIÅTIRILMIÅ PLAKA VE KISA SÄ°MÃœLASYON BÄ°LGÄ°LERÄ°\n"
        rapor += f"  - **Åehir AdÄ±**:    {sehir_adi}\n"
        rapor += f"  - **Plaka Tipi**:   {self.plaka_tipi}\n"
        rapor += f"  - **Ruhsat Sahibi**: {kullanici_bilgileri.get('Ruhsat Sahibi')}\n"
        rapor += f"  - **Telefon No**:    {kullanici_bilgileri.get('Telefon NumarasÄ±')}\n"
        rapor += f"  - **BorÃ§ Durumu**:   {kullanici_bilgileri.get('Trafik CezasÄ± Borcu')}\n"
        rapor += f"{ayirici}\n"

        rapor += "ğŸ’¡ DEVAM ETMEK Ä°Ã‡Ä°N KOMUT GÄ°RÄ°N:\n"
        rapor += "  - **`/araÅŸtir`**: DetaylÄ± ruhsat sahibi ve araÃ§ bilgilerini aÃ§ar.\n"
        rapor += "  - **`/bilgilendirme`**: SimÃ¼lasyon eylemleri (SMS, E-posta) menÃ¼sÃ¼nÃ¼ aÃ§ar.\n"
        rapor += "  - **`yeni`**: Yeni plaka kontrolÃ¼ baÅŸlatÄ±r.\n"
        rapor += f"{ayirici}\n"

        return rapor


# --- ANA PROGRAM VE KOMUT Ä°ÅLEYÄ°CÄ°LER ---

def goster_arastir_menusu(plaka_kontrol_nesnesi):
    """/araÅŸtir komutu altÄ±ndaki detaylÄ± bilgileri gÃ¶sterir."""
    veri = plaka_kontrol_nesnesi.simule_veri

    print("\n" + "=" * 70)
    print("| ğŸ•µï¸ DETAYLI RUHSAT SAHÄ°BÄ° VE Ã–ZEL BÄ°LGÄ°LER (SÄ°MÃœLASYON) ")
    print("=" * 70)

    print("  - **Ruhsat Sahibi AdÄ±**:    " + veri.get("Ruhsat Sahibi"))
    print("  - **TC Kimlik No**:         " + str(veri.get("TC Kimlik No")))
    print("  - **DoÄŸum Tarihi**:         " + veri.get("Dogum Tarihi"))
    print("  - **DoÄŸum Yeri**:           " + veri.get("Dogum Yeri"))
    print("  - **KÃ¼tÃ¼k Ä°l/Ä°lÃ§e**:        " + veri.get("KÃ¼tÃ¼k Ä°l/Ä°lÃ§e"))
    print("  - **Ä°kametgah Adresi**:     " + veri.get("Ikametgah Adresi"))
    print("  - **Marka / Model**:        " + veri.get("Marka / Model"))
    print("  - **Banka HesabÄ± Bakiyesi**: " + veri.get("Banka Hesabi Bakiyesi"))  # En hassas kÄ±sÄ±m!

    print("\nâš ï¸ YUKARIDAKÄ° TÃœM BÄ°LGÄ°LER BÄ°R YAZILIM TARAFINDAN RASGELE ÃœRETÄ°LMÄ°ÅTÄ°R VE GERÃ‡EK DEÄÄ°LDÄ°R.")
    print("=" * 70)


def goster_bilgilendirme_menusu():
    """/bilgilendirme komutu altÄ±ndaki seÃ§enekleri gÃ¶sterir."""
    print("\n" + "=" * 70)
    print("| ğŸ“ BÄ°LGÄ°LENDÄ°RME VE EYLEM SÄ°MÃœLASYONU MENÃœSÃœ ")
    print("=" * 70)
    print("  - **`/sms`**: BorÃ§ durumu ile ilgili kÄ±sa mesaj gÃ¶nderimini simÃ¼le eder.")
    print("  - **`/eposta`**: Sigorta yenileme uyarÄ±sÄ± e-postasÄ± gÃ¶nderimini simÃ¼le eder.")
    print("  - **`geri`**: Ana menÃ¼ye dÃ¶ner.")
    print("=" * 70)


def isleyici_bilgilendirme(plaka_kontrol_nesnesi, alt_komut):
    """/bilgilendirme altÄ±ndaki komutlarÄ± iÅŸler."""
    veri = plaka_kontrol_nesnesi.simule_veri

    if alt_komut == "/sms":
        print("\n" + "*" * 70)
        print(f"SMS GÃ–NDERÄ°MÄ° SÄ°MÃœLE EDÄ°LÄ°YOR...")
        print(f"ALICI: {veri.get('Telefon NumarasÄ±')}")
        print(
            f"MESAJ: SayÄ±n {veri.get('Ruhsat Sahibi')}, {plaka_kontrol_nesnesi.orijinal_plaka} plakalÄ± aracÄ±nÄ±zÄ±n Trafik CezasÄ± Borcu: {veri.get('Trafik CezasÄ± Borcu')}.")
        print(f"Durum: BAÅARILI. (Bu bir simÃ¼lasyondur.)")
        print("*" * 70)
    elif alt_komut == "/eposta":
        print("\n" + "*" * 70)
        print(f"E-POSTA GÃ–NDERÄ°MÄ° SÄ°MÃœLE EDÄ°LÄ°YOR...")
        print(f"ALICI: {veri.get('Ruhsat Sahibi')} iÃ§in rastgele bir e-posta adresi.")
        print(f"KONU: Sigorta SÃ¼resi YaklaÅŸÄ±yor!")
        print(
            f"MESAJ: {plaka_kontrol_nesnesi.orijinal_plaka} plakalÄ± aracÄ±nÄ±zÄ±n Zorunlu Sigorta durumu: {veri.get('Sigorta Durumu')}. SÃ¼renizi kontrol edin.")
        print(f"Durum: BAÅARILI. (Bu bir simÃ¼lasyondur.)")
        print("*" * 70)
    else:
        print("Bilinmeyen alt komut. LÃ¼tfen `/sms`, `/eposta` veya `geri` yazÄ±n.")
        goster_bilgilendirme_menusu()


def main():
    """Ana interaktif dÃ¶ngÃ¼yÃ¼ ve komut iÅŸleyicisini yÃ¶netir."""
    print("\n>>> T.C. PLAKA KONTROL SÄ°STEMÄ° (v6.0 - Ä°nteraktif SimÃ¼lasyon)")

    current_plaka_nesnesi = None
    aktif_mod = "ANA"  # ANA, BILGILENDIRME

    while True:
        prompt = "PLAKA GÄ°RÄ°ÅÄ° > " if current_plaka_nesnesi is None else f"KOMUT ({aktif_mod}) > "

        try:
            giris = input(prompt).strip()
            if not giris:
                continue

            giris_lower = giris.lower()

            if giris_lower in ('q', 'exit'):
                print("Program sonlandÄ±rÄ±lÄ±yor. Ä°yi gÃ¼nler!")
                break

            # --- ANA MOD Ä°ÅLEME ---
            if current_plaka_nesnesi is None or giris_lower == 'yeni':
                # Yeni plaka giriÅŸi veya 'yeni' komutu
                if giris_lower == 'yeni':
                    print("\n[INFO] Yeni plaka kontrolÃ¼ baÅŸlatÄ±lÄ±yor.")

                kontrol_nesnesi = PlakaKontrol(giris)
                rapor = kontrol_nesnesi.raporu_olustur()
                print(rapor)

                if kontrol_nesnesi.gecerli:
                    current_plaka_nesnesi = kontrol_nesnesi
                    aktif_mod = "ANA"
                else:
                    current_plaka_nesnesi = None
                    aktif_mod = "ANA"

            # --- KOMUT MODU Ä°ÅLEME (Plaka geÃ§erliyse) ---
            elif current_plaka_nesnesi is not None:
                if aktif_mod == "ANA":
                    if giris_lower == "/araÅŸtir":
                        goster_arastir_menusu(current_plaka_nesnesi)
                    elif giris_lower == "/bilgilendirme":
                        goster_bilgilendirme_menusu()
                        aktif_mod = "BILGILENDIRME"
                    elif giris_lower == "yeni":
                        current_plaka_nesnesi = None  # DÃ¶ngÃ¼ baÅŸÄ±nda yeni plaka giriÅŸine yÃ¶nlendirilecek
                        continue
                    else:
                        print("Bilinmeyen komut. LÃ¼tfen `/araÅŸtir`, `/bilgilendirme` veya `yeni` yazÄ±n.")

                elif aktif_mod == "BILGILENDIRME":
                    if giris_lower == "geri":
                        aktif_mod = "ANA"
                        print("Ana komut menÃ¼sÃ¼ne dÃ¶nÃ¼ldÃ¼.")
                        print("Mevcut komutlar: /araÅŸtir, /bilgilendirme, yeni")
                    else:
                        isleyici_bilgilendirme(current_plaka_nesnesi, giris_lower)

        except Exception as e:
            print(f"Beklenmedik bir hata oluÅŸtu: {e}")
            break


if __name__ == "__main__":
    main()
